name: Update All Economic Data (Enhanced EUR Support)
on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6:00 AM UTC
  workflow_dispatch:

jobs:
  update-economic-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 lxml pandas --break-system-packages
      
      - name: Create data directory
        run: mkdir -p economic-data
      
      - name: Scrape all economic indicators
        run: |
          cat > scrape_economics.py << 'EOFPYTHON'
          import requests
          from bs4 import BeautifulSoup
          import json
          import re
          from datetime import date
          import time
          
          HEADERS = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
              'Accept-Language': 'en-US,en;q=0.9',
          }
          
          # Country mapping
          COUNTRY_MAP = {
              'United States': 'USD',
              'Euro Area': 'EUR',
              'United Kingdom': 'GBP',
              'Japan': 'JPY',
              'Canada': 'CAD',
              'Australia': 'AUD',
              'Switzerland': 'CHF',
              'New Zealand': 'NZD'
          }
          
          # World Bank country codes for Trade Balance
          WB_COUNTRY_CODES = {
              'USD': 'USA',
              'EUR': None,  # Aggregate manually from major EUR countries
              'GBP': 'GBR',
              'JPY': 'JPN',
              'CAD': 'CAN',
              'AUD': 'AUS',
              'CHF': 'CHE',
              'NZD': 'NZL'
          }
          
          # Major Eurozone countries for EUR aggregation
          EUR_AGGREGATE_COUNTRIES = {
              'DEU': 0.30,  # Germany ~30% of Eurozone GDP
              'FRA': 0.22,  # France ~22%
              'ITA': 0.17,  # Italy ~17%
              'ESP': 0.13,  # Spain ~13%
              'NLD': 0.09,  # Netherlands ~9%
              'BEL': 0.05,  # Belgium ~5%
              'AUT': 0.04   # Austria ~4%
          }
          
          def clean_number(text):
              """Extract numeric value from text"""
              if not text:
                  return None
              text = str(text).strip().replace(',', '').replace('%', '')
              match = re.search(r'(-?\d+\.?\d*)', text)
              if match:
                  try:
                      return float(match.group(1))
                  except:
                      pass
              return None
          
          def scrape_trading_economics(url, indicator_name):
              """Generic scraper for Trading Economics country lists"""
              print(f"\n{'='*70}")
              print(f"Scraping: {indicator_name}")
              print(f"URL: {url}")
              print(f"{'='*70}")
              
              try:
                  response = requests.get(url, headers=HEADERS, timeout=20)
                  response.raise_for_status()
                  soup = BeautifulSoup(response.content, 'lxml')
                  
                  data = {}
                  
                  # Find the main data table
                  table = soup.find('table', {'class': 'table'})
                  if not table:
                      print(f"  âŒ No table found")
                      return data
                  
                  # Parse table rows
                  rows = table.find_all('tr')[1:]  # Skip header
                  
                  for row in rows:
                      cols = row.find_all('td')
                      if len(cols) < 2:
                          continue
                      
                      country_text = cols[0].get_text(strip=True)
                      value_text = cols[1].get_text(strip=True)
                      
                      # Match country to currency code
                      for country_name, currency_code in COUNTRY_MAP.items():
                          if country_name.lower() in country_text.lower():
                              value = clean_number(value_text)
                              if value is not None:
                                  data[currency_code] = value
                                  print(f"  âœ“ {currency_code}: {value}")
                              break
                  
                  missing = [c for c in COUNTRY_MAP.values() if c not in data]
                  if missing:
                      print(f"  âš ï¸  Missing: {', '.join(missing)}")
                  
                  return data
                  
              except Exception as e:
                  print(f"  âŒ Error: {str(e)}")
                  return {}
          
          def fetch_eurozone_trade_balance_aggregate():
              """
              Calculate EUR trade balance by aggregating major Eurozone countries
              Uses World Bank data for individual countries with GDP weights
              """
              print(f"\n{'='*70}")
              print("Calculating EUR Trade Balance (Weighted Aggregate)")
              print(f"{'='*70}")
              
              total_value = 0
              total_weight = 0
              country_data = {}
              
              for country_code, weight in EUR_AGGREGATE_COUNTRIES.items():
                  try:
                      url = f"https://api.worldbank.org/v2/country/{country_code}/indicator/NE.RSB.GNFS.CD?format=json&per_page=5&date=2020:2024"
                      
                      response = requests.get(url, timeout=15)
                      response.raise_for_status()
                      
                      data = response.json()
                      
                      if len(data) > 1 and data[1]:
                          for entry in data[1]:
                              if entry.get('value') is not None:
                                  value_billions = entry['value'] / 1_000_000_000
                                  country_data[country_code] = {
                                      'value': value_billions,
                                      'year': entry['date'],
                                      'weight': weight
                                  }
                                  
                                  weighted_value = value_billions * weight
                                  total_value += weighted_value
                                  total_weight += weight
                                  
                                  country_name = {
                                      'DEU': 'Germany', 'FRA': 'France', 'ITA': 'Italy',
                                      'ESP': 'Spain', 'NLD': 'Netherlands', 'BEL': 'Belgium',
                                      'AUT': 'Austria'
                                  }.get(country_code, country_code)
                                  
                                  print(f"  {country_name:12} ({weight*100:5.1f}%): {value_billions:+8.2f}B â†’ weighted: {weighted_value:+8.2f}B")
                                  break
                      
                      time.sleep(0.3)
                      
                  except Exception as e:
                      print(f"  âš ï¸  {country_code} failed: {str(e)}")
              
              if total_weight > 0:
                  # Normalize to 100% if we didn't get all countries
                  final_value = total_value / total_weight
                  print(f"\n  âœ… EUR Aggregate: {final_value:+.2f}B USD (coverage: {total_weight*100:.1f}%)")
                  return round(final_value, 2)
              
              return None
          
          def scrape_ecb_trade_balance_eur():
              """
              Alternative: Try to get EUR trade balance from ECB Statistical Data Warehouse
              """
              print(f"\n{'='*70}")
              print("Trying ECB Statistical Data Warehouse for EUR")
              print(f"{'='*70}")
              
              try:
                  # ECB Data Portal - Balance of Payments
                  # BOP.Q.U2.N.CA.F.F._Z._Z._Z.EUR._T._X.N
                  url = "https://data-api.ecb.europa.eu/service/data/BP6/Q.N.I8.W1.S1.S1.T.B.CA._Z._Z._Z.EUR._T.F.V.N"
                  
                  response = requests.get(url, headers={'Accept': 'application/json'}, timeout=15)
                  
                  if response.ok:
                      data = response.json()
                      # Parse ECB's complex JSON structure
                      if 'dataSets' in data and data['dataSets']:
                          observations = data['dataSets'][0].get('series', {})
                          if observations:
                              # Get most recent value
                              first_series = list(observations.values())[0].get('observations', {})
                              if first_series:
                                  latest_value = list(first_series.values())[-1][0]
                                  # ECB reports in millions EUR, convert to billions USD
                                  # Approximate EUR to USD conversion (1.10)
                                  value_billions = (latest_value / 1000) * 1.10
                                  print(f"  âœ… EUR (ECB): {value_billions:+.2f}B USD (estimated)")
                                  return round(value_billions, 2)
              
              except Exception as e:
                  print(f"  âš ï¸  ECB fetch failed: {str(e)}")
              
              return None
          
          def scrape_trading_economics_eur_fallback():
              """
              Last resort: Scrape EUR trade balance from Trading Economics
              and convert to USD manually
              """
              print(f"\n{'='*70}")
              print("Fallback: Trading Economics EUR Trade Balance")
              print(f"{'='*70}")
              
              try:
                  url = "https://tradingeconomics.com/euro-area/balance-of-trade"
                  response = requests.get(url, headers=HEADERS, timeout=15)
                  
                  if response.ok:
                      soup = BeautifulSoup(response.content, 'lxml')
                      
                      # Find the current value
                      value_elem = soup.find('div', {'id': 'ctl00_ContentPlaceHolder1_ctl01_ctl00_Panel1'})
                      if value_elem:
                          text = value_elem.get_text(strip=True)
                          value = clean_number(text)
                          
                          if value is not None:
                              # Trading Economics shows in billions EUR
                              # Convert to USD (approximate rate 1.10)
                              value_usd = value * 1.10
                              print(f"  âœ… EUR (Trading Economics): {value}B EUR â†’ {value_usd:+.2f}B USD")
                              return round(value_usd, 2)
              
              except Exception as e:
                  print(f"  âš ï¸  Trading Economics fallback failed: {str(e)}")
              
              return None
          
          def get_eur_trade_balance():
              """
              Multi-strategy EUR trade balance acquisition
              Priority: 1) Aggregate WB data, 2) ECB, 3) Trading Economics
              """
              print(f"\n{'='*70}")
              print("SPECIAL HANDLING: EUR TRADE BALANCE")
              print(f"{'='*70}")
              
              # Strategy 1: Weighted aggregate from major countries
              value = fetch_eurozone_trade_balance_aggregate()
              if value is not None:
                  return value
              
              print("\nâš ï¸  Weighted aggregate failed, trying ECB...")
              
              # Strategy 2: ECB Statistical Data Warehouse
              value = scrape_ecb_trade_balance_eur()
              if value is not None:
                  return value
              
              print("\nâš ï¸  ECB failed, trying Trading Economics...")
              
              # Strategy 3: Trading Economics with manual conversion
              value = scrape_trading_economics_eur_fallback()
              if value is not None:
                  return value
              
              print("\nâŒ All EUR strategies failed!")
              return None
          
          def scrape_world_bank_trade_balance():
              """
              Scrape Trade Balance from World Bank API
              Returns data in billions USD (standardized)
              """
              print(f"\n{'='*70}")
              print("Scraping: Trade Balance (World Bank API)")
              print(f"{'='*70}")
              
              data = {}
              
              # World Bank API endpoint for Trade Balance
              base_url = "https://api.worldbank.org/v2/country/{}/indicator/NE.RSB.GNFS.CD"
              
              for currency_code, wb_code in WB_COUNTRY_CODES.items():
                  # Special handling for EUR
                  if currency_code == 'EUR':
                      print(f"\n  EUR: Using special aggregate method...")
                      continue
                  
                  if not wb_code:
                      continue
                  
                  try:
                      url = f"{base_url.format(wb_code)}?format=json&per_page=5&date=2020:2024"
                      
                      print(f"  Fetching {currency_code} ({wb_code})...")
                      response = requests.get(url, timeout=15)
                      response.raise_for_status()
                      
                      json_data = response.json()
                      
                      if len(json_data) > 1 and json_data[1]:
                          for entry in json_data[1]:
                              if entry.get('value') is not None:
                                  value_billions = entry['value'] / 1_000_000_000
                                  data[currency_code] = round(value_billions, 2)
                                  print(f"  âœ“ {currency_code}: {data[currency_code]:+.2f}B USD ({entry['date']})")
                                  break
                      
                      time.sleep(0.5)
                      
                  except Exception as e:
                      print(f"  âŒ {currency_code} error: {str(e)}")
              
              # Now handle EUR with special methods
              eur_value = get_eur_trade_balance()
              if eur_value is not None:
                  data['EUR'] = eur_value
              
              return data
          
          # ============================================
          # SCRAPE ALL INDICATORS
          # ============================================
          
          indicators = {
              'gdp': 'https://tradingeconomics.com/country-list/gdp?continent=world',
              'gdpGrowth': 'https://tradingeconomics.com/country-list/gdp-growth-rate?continent=world',
              'inflation': 'https://tradingeconomics.com/country-list/inflation-rate?continent=world',
              'unemployment': 'https://tradingeconomics.com/country-list/unemployment-rate?continent=world',
              'debt': 'https://tradingeconomics.com/country-list/government-debt-to-gdp',
              'currentAccount': 'https://tradingeconomics.com/country-list/current-account-to-gdp?continent=world',
              'production': 'https://tradingeconomics.com/country-list/industrial-production?continent=world'
          }
          
          all_data = {}
          today = str(date.today())
          
          # Scrape standard indicators from Trading Economics
          for indicator_key, url in indicators.items():
              indicator_data = scrape_trading_economics(url, indicator_key)
              
              for currency, value in indicator_data.items():
                  if currency not in all_data:
                      all_data[currency] = {}
                  all_data[currency][indicator_key] = value
              
              time.sleep(2)
          
          # ============================================
          # SCRAPE TRADE BALANCE (WITH EUR SPECIAL HANDLING)
          # ============================================
          
          trade_balance_data = scrape_world_bank_trade_balance()
          
          for currency, value in trade_balance_data.items():
              if currency not in all_data:
                  all_data[currency] = {}
              all_data[currency]['tradeBalance'] = value
          
          # ============================================
          # SAVE RESULTS
          # ============================================
          
          print(f"\n{'='*70}")
          print("SAVING RESULTS")
          print(f"{'='*70}")
          
          for currency in COUNTRY_MAP.values():
              if currency in all_data:
                  data_package = {
                      'lastUpdate': today,
                      'source': 'TradingEconomics + WorldBank',
                      'data': all_data[currency]
                  }
                  
                  with open(f'economic-data/{currency}.json', 'w') as f:
                      json.dump(data_package, f, indent=2)
                  
                  print(f"  ğŸ’¾ {currency}: {len(all_data[currency])} indicators saved")
          
          # ============================================
          # VALIDATION
          # ============================================
          
          print(f"\n{'='*70}")
          print("VALIDATION")
          print(f"{'='*70}")
          
          required_currencies = list(COUNTRY_MAP.values())
          all_indicators = list(indicators.keys()) + ['tradeBalance']
          
          all_valid = True
          
          for currency in required_currencies:
              if currency not in all_data:
                  print(f"âŒ Missing entire dataset for {currency}")
                  all_valid = False
                  continue
              
              missing_indicators = [ind for ind in all_indicators if ind not in all_data[currency]]
              if missing_indicators:
                  print(f"âš ï¸  {currency} missing: {', '.join(missing_indicators)}")
                  if 'tradeBalance' in missing_indicators:
                      all_valid = False
              else:
                  print(f"âœ… {currency}: Complete ({len(all_data[currency])} indicators)")
              
              if 'tradeBalance' in all_data[currency]:
                  tb_value = all_data[currency]['tradeBalance']
                  print(f"   ğŸ’µ Trade Balance: {tb_value:+.2f}B USD")
          
          if not all_valid:
              print("\nâš ï¸  VALIDATION WARNING - Trade Balance data incomplete")
              exit(1)
          else:
              print("\nâœ… ALL DATA SUCCESSFULLY SCRAPED!")
          
          print("\n" + "="*70)
          print("TRADE BALANCE SUMMARY (All in billions USD)")
          print("="*70)
          for currency in sorted(required_currencies):
              if currency in all_data and 'tradeBalance' in all_data[currency]:
                  tb = all_data[currency]['tradeBalance']
                  status = "Surplus" if tb > 0 else "Deficit"
                  print(f"{currency}: {tb:+10.2f}B USD ({status})")
          
          EOFPYTHON
          
          python scrape_economics.py
      
      - name: Display sample results
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ECONOMIC DATA SCRAPING RESULTS         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          for currency in USD EUR GBP JPY AUD CAD CHF NZD; do
            if [ -f "economic-data/$currency.json" ]; then
              echo "[$currency]"
              cat "economic-data/$currency.json"
              echo ""
            fi
          done
      
      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add economic-data/
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ”„ Auto-update economic data $(date +'%Y-%m-%d %H:%M UTC')"
            git pull --rebase origin main || true
            git push
          fi
