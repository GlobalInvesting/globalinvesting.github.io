name: Update All Economic Data (FIXED - Monthly Data in USD MILLIONS)
on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6:00 AM UTC
  workflow_dispatch:

jobs:
  update-economic-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 lxml --break-system-packages
      
      - name: Create data directory
        run: mkdir -p economic-data
      
      - name: Scrape all economic indicators (FIXED - USD MILLIONS for trade balance)
        run: |
          cat > scrape_economics.py << 'EOFPYTHON'
          import requests
          from bs4 import BeautifulSoup
          import json
          import re
          from datetime import date
          import time
          
          HEADERS = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
              'Accept-Language': 'en-US,en;q=0.9',
          }
          
          # ============================================
          # CONFIGURATION
          # ============================================
          
          CURRENCIES = ['USD', 'EUR', 'GBP', 'JPY', 'CAD', 'AUD', 'CHF', 'NZD']
          
          # Trading Economics table URLs (all data is monthly)
          INDICATOR_URLS = {
              'gdp': 'https://tradingeconomics.com/country-list/gdp?continent=world',
              'gdpGrowth': 'https://tradingeconomics.com/country-list/gdp-growth-rate?continent=world',
              'inflation': 'https://tradingeconomics.com/country-list/inflation-rate?continent=world',
              'unemployment': 'https://tradingeconomics.com/country-list/unemployment-rate?continent=world',
              'debt': 'https://tradingeconomics.com/country-list/government-debt-to-gdp',
              'currentAccount': 'https://tradingeconomics.com/country-list/current-account-to-gdp?continent=world',
              'production': 'https://tradingeconomics.com/country-list/industrial-production?continent=world',
              'tradeBalance': 'https://tradingeconomics.com/country-list/balance-of-trade'
          }
          
          # Country name mapping (as they appear in Trading Economics tables)
          COUNTRY_NAMES = {
              'USD': ['United States', 'USA'],
              'EUR': ['Euro Area', 'Eurozone'],
              'GBP': ['United Kingdom', 'UK'],
              'JPY': ['Japan'],
              'CAD': ['Canada'],
              'AUD': ['Australia'],
              'CHF': ['Switzerland'],
              'NZD': ['New Zealand']
          }
          
          # Exchange rates cache
          exchange_rates = {}
          
          def fetch_exchange_rates():
              """
              Fetch current exchange rates to convert everything to USD
              """
              global exchange_rates
              
              print("\n" + "="*70)
              print("FETCHING LIVE EXCHANGE RATES")
              print("="*70)
              
              try:
                  # Try multiple free forex APIs
                  apis = [
                      'https://api.frankfurter.app/latest?from=USD',
                      'https://api.exchangerate-api.com/v4/latest/USD',
                      'https://open.er-api.com/v6/latest/USD'
                  ]
                  
                  for api_url in apis:
                      try:
                          response = requests.get(api_url, timeout=10)
                          if response.ok:
                              data = response.json()
                              rates = data.get('rates', {})
                              
                              if rates:
                                  exchange_rates = rates
                                  exchange_rates['USD'] = 1.0  # Base currency
                                  
                                  print("‚úÖ Exchange rates fetched successfully:")
                                  for currency in CURRENCIES:
                                      if currency != 'USD':
                                          rate = exchange_rates.get(currency, 'N/A')
                                          print(f"  1 USD = {rate} {currency}")
                                  return True
                      except:
                          continue
                  
                  print("‚ö†Ô∏è  All forex APIs failed, using fallback rates")
                  # Fallback approximate rates
                  exchange_rates = {
                      'USD': 1.0,
                      'EUR': 0.92,
                      'GBP': 0.79,
                      'JPY': 149.0,
                      'CAD': 1.36,
                      'AUD': 1.53,
                      'CHF': 0.88,
                      'NZD': 1.68
                  }
                  return True
                  
              except Exception as e:
                  print(f"‚ùå Error fetching exchange rates: {e}")
                  return False
          
          def get_currency_code_from_unit(unit_text):
              """
              Extract currency code from unit text (e.g., 'EUR Million' -> 'EUR')
              """
              if not unit_text:
                  return 'USD'
              
              # Common currency codes (ISO 4217)
              common_currencies = [
                  'USD', 'EUR', 'GBP', 'JPY', 'CAD', 'AUD', 'CHF', 'NZD',
                  'CNY', 'INR', 'BRL', 'MXN', 'ZAR', 'KRW', 'SGD', 'HKD',
                  'ALL', 'DZD', 'AOA', 'ARS', 'AMD', 'AWG', 'AZN', 'BSD',
                  'BHD', 'BDT', 'BBD', 'BYN', 'BZD', 'XOF', 'BMD', 'BTN',
                  'BOB', 'BAM', 'BWP', 'BND', 'BGN', 'BIF', 'KHR', 'XAF',
                  'CVE', 'KYD', 'CLP', 'COP', 'KMF', 'CRC', 'HRK', 'CUP',
                  'CZK', 'DKK', 'DJF', 'DOP', 'EGP', 'ETB', 'FJD', 'GMD',
                  'GEL', 'GHS', 'GTQ', 'GNF', 'GYD', 'HTG', 'HNL', 'HUF',
                  'ISK', 'IDR', 'IRR', 'IQD', 'ILS', 'JMD', 'JOD', 'KZT',
                  'KES', 'KWD', 'KGS', 'LAK', 'LBP', 'LSL', 'LRD', 'LYD',
                  'MOP', 'MKD', 'MGA', 'MWK', 'MYR', 'MVR', 'MRU', 'MUR',
                  'MDL', 'MNT', 'MAD', 'MZN', 'MMK', 'NAD', 'NPR', 'XPF',
                  'NIO', 'NGN', 'NOK', 'OMR', 'PKR', 'PAB', 'PGK', 'PYG',
                  'PEN', 'PHP', 'PLN', 'QAR', 'RON', 'RUB', 'RWF', 'WST',
                  'STN', 'SAR', 'RSD', 'SCR', 'SLE', 'SBD', 'SOS', 'SSP',
                  'LKR', 'SDG', 'SRD', 'SEK', 'SYP', 'TWD', 'TJS', 'TZS',
                  'THB', 'TOP', 'TTD', 'TND', 'TRY', 'TMT', 'UGX', 'UAH',
                  'AED', 'UYU', 'UZS', 'VUV', 'VES', 'VND', 'YER', 'ZMW',
                  'ZWL'
              ]
              
              for currency in common_currencies:
                  if currency in unit_text.upper():
                      return currency
              
              return 'USD'
          
          def get_scale_from_unit(unit_text):
              """
              Detect scale: Million, Billion, Trillion, Thousand
              Returns multiplier to convert to MILLIONS (not billions)
              
              FIXED: Now returns multiplier to convert to USD MILLIONS
              """
              if not unit_text:
                  return 1.0
              
              unit_lower = unit_text.lower()
              
              # Thousand variations ‚Üí to millions
              if any(word in unit_lower for word in ['thousand', 'k', 'thousands']):
                  return 0.001  # thousands to millions
              
              # Million variations (base unit)
              if any(word in unit_lower for word in ['million', 'mln', 'm ']):
                  return 1.0  # already in millions
              
              # Billion variations ‚Üí to millions
              if any(word in unit_lower for word in ['billion', 'bln', 'b ', 'bn']):
                  return 1000.0  # billions to millions
              
              # Trillion variations ‚Üí to millions
              if any(word in unit_lower for word in ['trillion', 'tln', 't ']):
                  return 1000000.0  # trillions to millions
              
              # Default: assume millions
              return 1.0
          
          def convert_to_usd_millions(value, currency_code, scale_multiplier, indicator_name):
              """
              Convert any value to USD MILLIONS (FIXED)
              
              Special handling:
              - GDP: Convert to TRILLIONS (divide millions by 1,000,000)
              - Trade Balance: Keep in MILLIONS
              - Other indicators: Keep as percentages
              """
              if value is None:
                  return None
              
              # Step 1: Apply scale to get to millions in local currency
              value_in_millions_local = value * scale_multiplier
              
              # Step 2: Convert to USD
              if currency_code == 'USD':
                  value_in_usd_millions = value_in_millions_local
              else:
                  fx_rate = exchange_rates.get(currency_code)
                  
                  if fx_rate is None:
                      print(f"    ‚ö†Ô∏è  No FX rate for {currency_code}, using value as-is")
                      return value_in_millions_local
                  
                  # Convert: divide by FX rate (since rates are USD=1 base)
                  value_in_usd_millions = value_in_millions_local / fx_rate
              
              # Step 3: Special handling for GDP (convert to trillions)
              if indicator_name == 'gdp':
                  return value_in_usd_millions / 1000.0  # Millions to Trillions
              
              # Step 4: Return millions for trade balance, raw value for percentages
              return value_in_usd_millions
          
          def clean_number(text):
              """Extract numeric value from text"""
              if not text:
                  return None
              text = str(text).strip().replace(',', '').replace('%', '')
              match = re.search(r'(-?\d+\.?\d*)', text)
              if match:
                  try:
                      return float(match.group(1))
                  except:
                      pass
              return None
          
          def scrape_trading_economics_table(url, indicator_name):
              """
              Scrape Trading Economics country list table
              Returns: {currency_code: value_in_correct_units}
              """
              print(f"\n{'='*70}")
              print(f"Scraping: {indicator_name}")
              print(f"URL: {url}")
              print(f"{'='*70}")
              
              try:
                  response = requests.get(url, headers=HEADERS, timeout=20)
                  response.raise_for_status()
                  soup = BeautifulSoup(response.content, 'lxml')
                  
                  data = {}
                  
                  # Find the main data table
                  table = soup.find('table', {'class': 'table'})
                  if not table:
                      print("  ‚ùå No table found")
                      return data
                  
                  # Parse table rows
                  rows = table.find_all('tr')[1:]  # Skip header
                  
                  for row in rows:
                      cols = row.find_all('td')
                      if len(cols) < 4:
                          continue
                      
                      country_text = cols[0].get_text(strip=True)
                      last_value_text = cols[1].get_text(strip=True)
                      unit_text = cols[3].get_text(strip=True) if len(cols) > 3 else ''
                      
                      # Match country to currency code
                      for currency_code, country_names in COUNTRY_NAMES.items():
                          if any(name.lower() in country_text.lower() for name in country_names):
                              # Extract numeric value
                              value = clean_number(last_value_text)
                              
                              if value is not None:
                                  # For percentage indicators, just store the value
                                  if indicator_name in ['gdpGrowth', 'inflation', 'unemployment', 'debt', 'currentAccount', 'production']:
                                      data[currency_code] = round(value, 2)
                                      print(f"  ‚úì {currency_code}: {value}% ({indicator_name})")
                                  else:
                                      # For monetary values (GDP, trade balance)
                                      currency_in_data = get_currency_code_from_unit(unit_text)
                                      scale = get_scale_from_unit(unit_text)
                                      
                                      # Convert to correct units
                                      converted_value = convert_to_usd_millions(
                                          value, 
                                          currency_in_data, 
                                          scale,
                                          indicator_name
                                      )
                                      
                                      if converted_value is not None:
                                          data[currency_code] = round(converted_value, 2)
                                          
                                          if indicator_name == 'gdp':
                                              print(f"  ‚úì {currency_code}: {value} {currency_in_data} {unit_text} ‚Üí ${converted_value:.2f}T USD")
                                          else:
                                              print(f"  ‚úì {currency_code}: {value} {currency_in_data} {unit_text} ‚Üí ${converted_value:.2f}M USD (monthly)")
                              
                              break
                  
                  missing = [c for c in CURRENCIES if c not in data]
                  if missing:
                      print(f"  ‚ö†Ô∏è  Missing: {', '.join(missing)}")
                  
                  return data
                  
              except Exception as e:
                  print(f"  ‚ùå Error: {str(e)}")
                  return {}
          
          def scrape_all_indicators():
              """
              Scrape all indicators from Trading Economics
              """
              print("="*70)
              print("SCRAPING ECONOMIC DATA - FIXED UNITS")
              print("="*70)
              
              all_data = {}
              
              # Initialize data structure
              for currency in CURRENCIES:
                  all_data[currency] = {}
              
              # Scrape each indicator
              for indicator_key, url in INDICATOR_URLS.items():
                  indicator_data = scrape_trading_economics_table(url, indicator_key)
                  
                  for currency_code, value in indicator_data.items():
                      all_data[currency_code][indicator_key] = value
                  
                  time.sleep(2)  # Be polite to the server
              
              return all_data
          
          def validate_data(all_data):
              """
              Validate scraped data
              """
              print(f"\n{'='*70}")
              print("VALIDATION")
              print(f"{'='*70}")
              
              for currency in CURRENCIES:
                  data = all_data.get(currency, {})
                  
                  missing = [ind for ind in INDICATOR_URLS.keys() if data.get(ind) is None]
                  
                  if missing:
                      print(f"‚ö†Ô∏è  {currency} missing: {', '.join(missing)}")
                  else:
                      print(f"‚úÖ {currency}: Complete ({len(data)} indicators)")
                  
                  # Sanity checks
                  if data.get('gdp'):
                      if data['gdp'] < 0.05 or data['gdp'] > 100:
                          print(f"  ‚ö†Ô∏è  GDP unusual: ${data['gdp']:.2f}T")
                  
                  if data.get('tradeBalance'):
                      if abs(data['tradeBalance']) > 1000000:  # > 1 trillion in millions
                          print(f"  ‚ö†Ô∏è  Trade balance unusual: ${data['tradeBalance']:.2f}M")
          
          def save_data(all_data):
              """Save data to JSON files"""
              print(f"\n{'='*70}")
              print("SAVING RESULTS")
              print(f"{'='*70}")
              
              today = str(date.today())
              
              for currency in CURRENCIES:
                  if currency in all_data:
                      data_package = {
                          'lastUpdate': today,
                          'source': 'TradingEconomics (Fixed Units)',
                          'methodology': 'Monthly data converted to correct units: GDP in Trillions USD, Trade Balance in Millions USD (monthly)',
                          'units': {
                              'gdp': 'Trillions USD',
                              'gdpGrowth': 'Percentage (%)',
                              'inflation': 'Percentage (%)',
                              'unemployment': 'Percentage (%)',
                              'debt': 'Percentage of GDP (%)',
                              'currentAccount': 'Percentage of GDP (%)',
                              'production': 'Percentage (%)',
                              'tradeBalance': 'Millions USD (monthly)'
                          },
                          'data': all_data[currency]
                      }
                      
                      with open(f'economic-data/{currency}.json', 'w') as f:
                          json.dump(data_package, f, indent=2)
                      
                      print(f"  üíæ {currency}.json")
          
          def print_summary(all_data):
              """Print summary"""
              print(f"\n{'='*70}")
              print("TRADE BALANCE SUMMARY (Monthly, USD Millions)")
              print(f"{'='*70}")
              
              # Sort by trade balance
              sorted_currencies = sorted(
                  CURRENCIES,
                  key=lambda c: all_data.get(c, {}).get('tradeBalance', 0),
                  reverse=True
              )
              
              for currency in sorted_currencies:
                  tb = all_data.get(currency, {}).get('tradeBalance')
                  if tb is not None:
                      status = "Surplus" if tb > 0 else "Deficit"
                      print(f"{currency}: {tb:+12,.2f}M USD/month ({status})")
              
              print(f"\n{'='*70}")
              print("‚úÖ SCRAPING COMPLETED - UNITS FIXED")
              print("   ‚Ä¢ GDP in Trillions USD")
              print("   ‚Ä¢ Trade Balance in Millions USD (monthly)")
              print("   ‚Ä¢ Percentages unchanged")
              print(f"{'='*70}")
          
          # ============================================
          # MAIN EXECUTION
          # ============================================
          
          if __name__ == '__main__':
              # Step 1: Fetch exchange rates
              if not fetch_exchange_rates():
                  print("‚ùå Failed to fetch exchange rates, aborting")
                  exit(1)
              
              # Step 2: Scrape all data
              all_data = scrape_all_indicators()
              
              # Step 3: Validate
              validate_data(all_data)
              
              # Step 4: Save
              save_data(all_data)
              
              # Step 5: Summary
              print_summary(all_data)
          
          EOFPYTHON
          
          python scrape_economics.py
      
      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add economic-data/
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üîß FIXED: Correct unit conversion - GDP in Trillions, Trade Balance in Millions USD $(date +'%Y-%m-%d %H:%M UTC')"
            git pull --rebase origin main || true
            git push
          fi
