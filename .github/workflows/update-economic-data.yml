name: Update Economic Data - Hybrid (TE + Investing Fallback)
on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:

jobs:
  update-economic-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 lxml --break-system-packages
      
      - name: Create data directory
        run: mkdir -p economic-data
      
      - name: Scrape economic data (hybrid mode)
        run: |
          python3 << 'EOFPYTHON'
          import requests
          from bs4 import BeautifulSoup
          import json
          import re
          from datetime import date
          import time
          
          HEADERS = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
              'Accept-Language': 'en-US,en;q=0.9',
          }
          
          CURRENCIES = ['USD', 'EUR', 'GBP', 'JPY', 'CAD', 'AUD', 'CHF', 'NZD']
          
          TRADING_ECONOMICS_URLS = {
              'gdp': 'https://tradingeconomics.com/country-list/gdp?continent=world',
              'gdpGrowth': 'https://tradingeconomics.com/country-list/gdp-growth-rate?continent=world',
              'inflation': 'https://tradingeconomics.com/country-list/inflation-rate?continent=world',
              'unemployment': 'https://tradingeconomics.com/country-list/unemployment-rate?continent=world',
              'debt': 'https://tradingeconomics.com/country-list/government-debt-to-gdp',
              'currentAccount': 'https://tradingeconomics.com/country-list/current-account-to-gdp?continent=world',
              'production': 'https://tradingeconomics.com/country-list/industrial-production?continent=world',
              'tradeBalance': 'https://tradingeconomics.com/country-list/balance-of-trade',
              'retailSales': 'https://tradingeconomics.com/country-list/retail-sales-mom',
              'wageGrowth': 'https://tradingeconomics.com/country-list/wage-growth',
              'manufacturingPMI': 'https://tradingeconomics.com/country-list/manufacturing-pmi'
          }
          
          INVESTING_FALLBACK_URLS = {
              'retailSales': {
                  'AUD': 'https://www.investing.com/economic-calendar/australia-retail-sales-mom-262',
                  'USD': 'https://www.investing.com/economic-calendar/retail-sales-169',
                  'EUR': 'https://www.investing.com/economic-calendar/retail-sales-901',
                  'GBP': 'https://www.investing.com/economic-calendar/retail-sales-238',
                  'JPY': 'https://www.investing.com/economic-calendar/retail-sales-526',
                  'CAD': 'https://www.investing.com/economic-calendar/retail-sales-166',
                  'CHF': 'https://www.investing.com/economic-calendar/retail-sales-1672',
                  'NZD': 'https://www.investing.com/economic-calendar/retail-sales-1127'
              }
          }
          
          COUNTRY_NAMES = {
              'USD': ['United States', 'USA'],
              'EUR': ['Euro Area', 'Eurozone'],
              'GBP': ['United Kingdom', 'UK'],
              'JPY': ['Japan'],
              'CAD': ['Canada'],
              'AUD': ['Australia'],
              'CHF': ['Switzerland'],
              'NZD': ['New Zealand']
          }
          
          exchange_rates = {}
          
          def fetch_exchange_rates():
              global exchange_rates
              try:
                  response = requests.get('https://api.frankfurter.app/latest?from=USD', timeout=10)
                  if response.ok:
                      exchange_rates = response.json().get('rates', {})
                      exchange_rates['USD'] = 1.0
                      return True
              except:
                  pass
              exchange_rates = {'USD': 1.0, 'EUR': 0.84, 'GBP': 0.73, 'JPY': 153.71,
                               'CAD': 1.36, 'AUD': 1.40, 'CHF': 0.77, 'NZD': 1.65}
              return True
          
          def clean_number(text):
              if not text:
                  return None
              text = str(text).strip().replace(',', '').replace('%', '').replace(' ', '')
              match = re.search(r'(-?\d+\.?\d*)', text)
              if match:
                  try:
                      return float(match.group(1))
                  except:
                      pass
              return None
          
          def scrape_investing_com(url, currency_code, indicator_name):
              print(f"    â†’ Fallback: Investing.com for {currency_code}...")
              try:
                  response = requests.get(url, headers=HEADERS, timeout=20)
                  if not response.ok:
                      return None
                  
                  soup = BeautifulSoup(response.content, 'lxml')
                  
                  # Method 1: dt/dd pairs
                  dts = soup.find_all('dt')
                  dds = soup.find_all('dd')
                  for i, dt in enumerate(dts):
                      if 'actual' in dt.get_text(strip=True).lower() and i < len(dds):
                          value = clean_number(dds[i].get_text(strip=True))
                          if value is not None:
                              print(f"    âœ… {currency_code}: {value} (Investing.com)")
                              return value
                  
                  # Method 2: Search text patterns
                  all_elements = soup.find_all(text=re.compile(r'-?\d+\.?\d*%'))
                  for elem in all_elements[:10]:
                      parent_text = elem.parent.get_text(strip=True).lower() if elem.parent else ''
                      if 'actual' in parent_text:
                          value = clean_number(elem)
                          if value is not None and -100 <= value <= 1000:
                              print(f"    âœ… {currency_code}: {value} (Investing.com)")
                              return value
                  
                  return None
              except Exception as e:
                  print(f"    âŒ Investing.com error: {e}")
                  return None
          
          def parse_trade_balance(cols, currency_code):
              if len(cols) < 5:
                  return None
              value = clean_number(cols[1].get_text(strip=True))
              unit_text = cols[4].get_text(strip=True)
              if value is None:
                  return None
              
              scale = 1000 if 'billion' in unit_text.lower() else 1
              source_curr = next((c for c in CURRENCIES if c in unit_text.upper()), 'USD')
              value_millions = value * scale
              
              if source_curr != 'USD':
                  fx = exchange_rates.get(source_curr, 1)
                  value_millions = value_millions / fx if fx else value_millions
              
              return round(value_millions, 2)
          
          def scrape_trading_economics(url, indicator_name):
              print(f"\n{'='*60}")
              print(f"SCRAPING: {indicator_name.upper()}")
              print(f"{'='*60}")
              
              try:
                  response = requests.get(url, headers=HEADERS, timeout=20)
                  response.raise_for_status()
                  soup = BeautifulSoup(response.content, 'lxml')
                  
                  data = {}
                  table = soup.find('table', {'class': 'table'})
                  if not table:
                      return data
                  
                  for row in table.find_all('tr')[1:]:
                      cols = row.find_all('td')
                      if len(cols) < 2:
                          continue
                      
                      country_text = cols[0].get_text(strip=True)
                      
                      for currency_code, country_names in COUNTRY_NAMES.items():
                          if any(name.lower() in country_text.lower() for name in country_names):
                              if indicator_name == 'tradeBalance':
                                  value = parse_trade_balance(cols, currency_code)
                              else:
                                  value = clean_number(cols[1].get_text(strip=True))
                              
                              if value is not None:
                                  data[currency_code] = round(value, 2)
                                  print(f"  âœ“ {currency_code}: {value}")
                              break
                  
                  return data
              except Exception as e:
                  print(f"  âŒ Error: {e}")
                  return {}
          
          def scrape_with_fallback(indicator_name, te_url):
              data = scrape_trading_economics(te_url, indicator_name)
              missing = [c for c in CURRENCIES if c not in data]
              
              if missing and indicator_name in INVESTING_FALLBACK_URLS:
                  print(f"\n  â†’ Trying fallback for: {', '.join(missing)}")
                  for currency_code in missing:
                      url = INVESTING_FALLBACK_URLS[indicator_name].get(currency_code)
                      if url:
                          value = scrape_investing_com(url, currency_code, indicator_name)
                          if value is not None:
                              data[currency_code] = value
                          time.sleep(1)
              
              return data
          
          def load_cot_data():
              import os
              cot_data = {}
              if not os.path.exists('cot-data'):
                  return {}
              
              for curr in ['EUR', 'GBP', 'JPY', 'CAD', 'AUD', 'CHF', 'NZD']:
                  filepath = f'cot-data/{curr}.json'
                  if os.path.exists(filepath):
                      try:
                          with open(filepath) as f:
                              cot_data[curr] = json.load(f).get('netPosition')
                      except:
                          pass
              return cot_data
          
          # MAIN
          print("="*60)
          print("HYBRID ECONOMIC DATA SCRAPER")
          print("="*60)
          
          fetch_exchange_rates()
          
          all_data = {c: {} for c in CURRENCIES}
          
          for indicator_key, url in TRADING_ECONOMICS_URLS.items():
              indicator_data = scrape_with_fallback(indicator_key, url)
              for currency_code, value in indicator_data.items():
                  all_data[currency_code][indicator_key] = value
              time.sleep(2)
          
          cot_data = load_cot_data()
          for currency_code, value in cot_data.items():
              all_data[currency_code]['cotPositioning'] = value
          
          # Save
          today = str(date.today())
          for currency in CURRENCIES:
              data_package = {
                  'lastUpdate': today,
                  'source': 'TradingEconomics + Investing.com',
                  'data': all_data[currency]
              }
              with open(f'economic-data/{currency}.json', 'w') as f:
                  json.dump(data_package, f, indent=2)
              
              missing = [k for k in ['retailSales', 'wageGrowth', 'manufacturingPMI'] 
                        if all_data[currency].get(k) is None]
              if missing:
                  print(f"âš ï¸  {currency}: Missing {', '.join(missing)}")
              else:
                  print(f"âœ… {currency}: Complete")
          
          print("\nâœ… COMPLETED")
          EOFPYTHON
      
      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add economic-data/
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "ðŸ“Š Economic data (hybrid) $(date +'%Y-%m-%d')"
            git pull --rebase origin main || true
            git push
          fi
