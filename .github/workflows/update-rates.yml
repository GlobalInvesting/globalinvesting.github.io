name: Update Interest Rates (FIXED - Central Bank Priority)
on:
  schedule:
    - cron: '0 8 * * *'  # Diario a las 8:00 AM UTC
  workflow_dispatch:

jobs:
  update-rates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq xmlstarlet
      
      - name: Create rates directory
        run: mkdir -p rates
      
      # ========================================
      # USD - Federal Reserve (Fed Funds Rate)
      # ========================================
      - name: Fetch USD rate
        run: |
          echo "ğŸ‡ºğŸ‡¸ Fetching USD rate..."
          
          # Source 1: FRED DFF (most reliable for US)
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=DFF&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // empty')
          
          if [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "." ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/USD.json
            echo "âœ“ USD: $RATE% (FRED)"
          else
            echo "âŒ USD: Failed"
          fi
      
      # ========================================
      # EUR - European Central Bank
      # ========================================
      - name: Fetch EUR rate
        run: |
          echo "ğŸ‡ªğŸ‡º Fetching EUR rate..."
          
          # Source 1: ECB Statistical Data Warehouse (OFFICIAL)
          RATE=$(curl -s "https://data-api.ecb.europa.eu/service/data/FM/M.U2.EUR.RT.MM.EURIBOR1MD_.HSTA?lastNObservations=1&format=jsondata" | jq -r '.dataSets[0].series[].observations[0][0] // empty' 2>/dev/null)
          
          # Source 2: FRED ECB Deposit Rate
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=ECBDFR&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // empty')
          fi
          
          # Source 3: FRED Main Refinancing
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=ECBMRRFR&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // empty')
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            if [ -f "rates/EUR.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/EUR.json)
              echo "âš ï¸ EUR: Using last known value: $RATE%"
            fi
          fi
          
          if [ -n "$RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/EUR.json
            echo "âœ“ EUR: $RATE%"
          fi
      
      # ========================================
      # GBP - Bank of England
      # ========================================
      - name: Fetch GBP rate
        run: |
          echo "ğŸ‡¬ğŸ‡§ Fetching GBP rate..."
          
          # Source 1: FRED Bank Rate
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IUDSOIA&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // empty')
          RATE_DATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IUDSOIA&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].date // empty')
          
          if [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "." ]; then
            YEAR=$(echo $RATE_DATE | cut -d'-' -f1)
            if [ "$YEAR" -ge 2025 ]; then
              echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$RATE_DATE\"}]}" > rates/GBP.json
              echo "âœ“ GBP: $RATE% (from $RATE_DATE)"
            fi
          else
            echo "âŒ GBP: Failed"
          fi
      
      # ========================================
      # JPY - Bank of Japan (FIXED 0.75%)
      # ========================================
      - name: Fetch JPY rate
        run: |
          echo "ğŸ‡¯ğŸ‡µ Fetching JPY rate..."
          
          # Source 1: Scrape Bank of Japan Official Website
          RATE=$(curl -s "https://www.boj.or.jp/en/mopo/outline/index.htm" | grep -oP '(?<=policy rate">)[0-9.]+(?=</span>)' | head -1)
          
          # Source 2: FRED Japan Policy Rate
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=JPNPOLICYRATE&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=5&sort_order=desc" | jq -r '.observations[] | select(.value != ".") | .value' | head -1)
          fi
          
          # Source 3: BIS Japan
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://data.bis.org/api/v1/data/CBPOL/M.JP?detail=dataonly&lastNObservations=1" | jq -r '.dataSets[0].series."0:0:0:0".observations."0"[0]' 2>/dev/null)
          fi
          
          # Source 4: Trading Economics API
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://api.tradingeconomics.com/country/japan?c=guest:guest&f=json" | jq -r '.[] | select(.Category == "Interest Rate") | .LatestValue' 2>/dev/null | head -1)
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            if [ -f "rates/JPY.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/JPY.json)
              echo "âš ï¸ JPY: Using last known value: $RATE%"
            fi
          fi
          
          if [ -n "$RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/JPY.json
            echo "âœ“ JPY: $RATE%"
          fi
      
      # ========================================
      # CAD - Bank of Canada (Official API)
      # ========================================
      - name: Fetch CAD rate
        run: |
          echo "ğŸ‡¨ğŸ‡¦ Fetching CAD rate..."
          
          # Source 1: Bank of Canada Valet API (OFFICIAL)
          CAD_RATE=$(curl -s "https://www.bankofcanada.ca/valet/observations/V39079/json?recent=1" | jq -r '.observations[0].V39079.v // empty')
          
          if [ -n "$CAD_RATE" ] && [ "$CAD_RATE" != "null" ]; then
            echo "{\"observations\":[{\"value\":\"$CAD_RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/CAD.json
            echo "âœ“ CAD: $CAD_RATE% (Bank of Canada Official API)"
          else
            echo "âŒ CAD: Failed"
          fi
      
      # ========================================
      # AUD - Reserve Bank of Australia (FIXED 3.85%)
      # ========================================
      - name: Fetch AUD rate
        run: |
          echo "ğŸ‡¦ğŸ‡º Fetching AUD rate..."
          
          # Source 1: Scrape RBA Official Website
          RATE=$(curl -s "https://www.rba.gov.au/statistics/cash-rate/" | grep -oP 'Cash Rate Target.*?(\d+\.\d+)' | grep -oP '\d+\.\d+' | head -1)
          
          # Source 2: RBA RSS Feed
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://www.rba.gov.au/rss/rss-cb-data.xml" | xmlstarlet sel -t -v "//item[1]/title" 2>/dev/null | grep -oP '\d+\.\d+' | head -1)
          fi
          
          # Source 3: FRED Australia
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IRSTCI01AUM156N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // empty')
          fi
          
          # Source 4: Trading Economics
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://api.tradingeconomics.com/country/australia?c=guest:guest&f=json" | jq -r '.[] | select(.Category == "Interest Rate") | .LatestValue' 2>/dev/null | head -1)
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            if [ -f "rates/AUD.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/AUD.json)
              echo "âš ï¸ AUD: Using last known value: $RATE%"
            fi
          fi
          
          if [ -n "$RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/AUD.json
            echo "âœ“ AUD: $RATE%"
          fi
      
      # ========================================
      # CHF - Swiss National Bank (FIXED 0.00%)
      # ========================================
      - name: Fetch CHF rate
        run: |
          echo "ğŸ‡¨ğŸ‡­ Fetching CHF rate..."
          
          # Source 1: SNB Data Portal (Official)
          RATE=$(curl -s "https://data.snb.ch/api/cube/zimoma/data/csv/en" | tail -1 | cut -d',' -f2 2>/dev/null | tr -d '\r' | xargs)
          
          # Source 2: Scrape SNB Website
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://www.snb.ch/en/the-snb/mandates-goals/monetary-policy" | grep -oP 'SNB policy rate.*?(\d+\.\d+)' | grep -oP '\d+\.\d+' | head -1)
          fi
          
          # Source 3: FRED Switzerland
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IRSTCI01CHM156N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // empty')
          fi
          
          # Source 4: BIS Switzerland
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://data.bis.org/api/v1/data/CBPOL/M.CH?detail=dataonly&lastNObservations=1" | jq -r '.dataSets[0].series."0:0:0:0".observations."0"[0]' 2>/dev/null)
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            if [ -f "rates/CHF.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/CHF.json)
              echo "âš ï¸ CHF: Using last known value: $RATE%"
            fi
          fi
          
          if [ -n "$RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/CHF.json
            echo "âœ“ CHF: $RATE%"
          fi
      
      # ========================================
      # NZD - Reserve Bank of New Zealand (FIXED 2.25%)
      # ========================================
      - name: Fetch NZD rate
        run: |
          echo "ğŸ‡³ğŸ‡¿ Fetching NZD rate..."
          
          # Source 1: Scrape RBNZ Official Website
          RATE=$(curl -s "https://www.rbnz.govt.nz/monetary-policy/official-cash-rate-decisions" | grep -oP 'OCR.*?(\d+\.\d+)' | grep -oP '\d+\.\d+' | head -1)
          
          # Source 2: RBNZ Statistics
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://www.rbnz.govt.nz/statistics/key-graphs/key-graph-ocr" | grep -oP 'current rate.*?(\d+\.\d+)' | grep -oP '\d+\.\d+' | head -1)
          fi
          
          # Source 3: FRED New Zealand
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IRSTCI01NZM156N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // empty')
          fi
          
          # Source 4: Trading Economics
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://api.tradingeconomics.com/country/new-zealand?c=guest:guest&f=json" | jq -r '.[] | select(.Category == "Interest Rate") | .LatestValue' 2>/dev/null | head -1)
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            if [ -f "rates/NZD.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/NZD.json)
              echo "âš ï¸ NZD: Using last known value: $RATE%"
            fi
          fi
          
          if [ -n "$RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/NZD.json
            echo "âœ“ NZD: $RATE%"
          fi
      
      # ========================================
      # DISPLAY FINAL RATES
      # ========================================
      - name: Display final rates
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  FINAL RATES (Central Bank Priority) â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          for currency in USD EUR GBP JPY AUD CAD CHF NZD; do
            if [ -f rates/$currency.json ]; then
              echo ""
              echo "[$currency]"
              jq -r '.observations[0] | "  Rate: \(.value)%\n  Date: \(.date)"' rates/$currency.json
            else
              echo ""
              echo "[$currency]"
              echo "  âŒ NO DATA AVAILABLE"
            fi
          done
      
      # ========================================
      # COMMIT AND PUSH
      # ========================================
      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add rates/
          git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ”„ Auto-update rates $(date +'%Y-%m-%d %H:%M UTC') - Central Bank Priority" && git push)
