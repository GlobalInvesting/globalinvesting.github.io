name: Backfill Historical Rates (Investing.com Exact Data)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Escribe "confirmar" para sobreescribir datos existentes'
        required: true
        default: 'confirmar'

jobs:
  backfill:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Write and run backfill script
        run: |
          cat > /tmp/write_rates.py << 'PYEOF'
          import json, os
          from datetime import date, datetime, timedelta

          DECISIONS = {
              'USD': [
                  ('2026-01-28', 3.75), ('2025-12-10', 3.75), ('2025-10-29', 4.00),
                  ('2025-09-17', 4.25), ('2025-07-30', 4.50), ('2025-06-18', 4.50),
                  ('2025-05-07', 4.50), ('2025-03-19', 4.50), ('2025-01-29', 4.50),
                  ('2024-12-18', 4.50), ('2024-11-07', 4.75), ('2024-09-18', 5.00),
                  ('2024-07-31', 5.50), ('2024-01-01', 5.50),
              ],
              'EUR': [
                  ('2026-02-05', 2.15), ('2025-12-18', 2.15), ('2025-10-30', 2.15),
                  ('2025-09-11', 2.15), ('2025-07-24', 2.15), ('2025-06-05', 2.15),
                  ('2025-04-17', 2.40), ('2025-03-06', 2.65), ('2025-01-30', 2.90),
                  ('2024-12-12', 3.15), ('2024-10-17', 3.40), ('2024-09-12', 3.65),
                  ('2024-07-18', 4.25), ('2024-06-06', 4.25), ('2024-04-11', 4.50),
                  ('2024-03-07', 4.50), ('2024-01-25', 4.50),
              ],
              'GBP': [
                  ('2026-02-05', 3.75), ('2025-12-18', 3.75), ('2025-11-06', 4.00),
                  ('2025-09-18', 4.00), ('2025-08-07', 4.00), ('2025-06-19', 4.25),
                  ('2025-05-08', 4.25), ('2025-03-20', 4.50), ('2025-02-06', 4.50),
                  ('2024-12-19', 4.75), ('2024-11-07', 4.75), ('2024-09-19', 5.00),
                  ('2024-08-01', 5.00), ('2024-06-20', 5.25), ('2024-05-09', 5.25),
                  ('2024-03-21', 5.25), ('2024-02-01', 5.25),
              ],
              'JPY': [
                  ('2026-01-23', 0.75), ('2025-12-19', 0.75), ('2025-10-30', 0.50),
                  ('2025-09-19', 0.50), ('2025-07-31', 0.50), ('2025-06-17', 0.50),
                  ('2025-05-01', 0.50), ('2025-03-18', 0.50), ('2025-01-24', 0.50),
                  ('2024-12-18', 0.25), ('2024-10-31', 0.25), ('2024-09-20', 0.25),
                  ('2024-07-31', 0.25), ('2024-06-14', 0.10), ('2024-04-26', 0.10),
                  ('2024-03-19', 0.10), ('2024-01-23', -0.10),
              ],
              'CAD': [
                  ('2026-01-28', 2.25), ('2025-12-10', 2.25), ('2025-10-29', 2.25),
                  ('2025-09-17', 2.50), ('2025-07-30', 2.75), ('2025-06-04', 2.75),
                  ('2025-04-16', 2.75), ('2025-03-12', 2.75), ('2025-01-29', 3.00),
                  ('2024-12-11', 3.25), ('2024-10-23', 3.75), ('2024-09-04', 4.25),
                  ('2024-07-24', 4.50), ('2024-06-05', 4.75), ('2024-04-10', 5.00),
                  ('2024-03-06', 5.00), ('2024-01-24', 5.00),
              ],
              'AUD': [
                  ('2026-02-03', 3.85), ('2025-12-09', 3.60), ('2025-11-04', 3.60),
                  ('2025-09-30', 3.60), ('2025-08-12', 3.60), ('2025-07-08', 3.85),
                  ('2025-05-20', 3.85), ('2025-04-01', 4.10), ('2025-02-18', 4.10),
                  ('2024-12-10', 4.35), ('2024-11-05', 4.35), ('2024-09-24', 4.35),
                  ('2024-08-06', 4.35), ('2024-06-18', 4.35), ('2024-05-07', 4.35),
                  ('2024-03-19', 4.35), ('2024-02-06', 4.35),
              ],
              'CHF': [
                  ('2025-12-11', 0.00), ('2025-09-25', 0.00), ('2025-06-19', 0.00),
                  ('2025-03-20', 0.25), ('2024-12-12', 0.50), ('2024-09-26', 1.00),
                  ('2024-06-20', 1.25), ('2024-03-21', 1.50), ('2023-12-14', 1.75),
              ],
              'NZD': [
                  ('2026-02-17', 2.25), ('2025-11-25', 2.25), ('2025-10-07', 2.50),
                  ('2025-08-19', 3.00), ('2025-07-08', 3.25), ('2025-05-27', 3.25),
                  ('2025-04-08', 3.50), ('2025-02-18', 3.75), ('2024-11-26', 4.25),
                  ('2024-10-08', 4.75), ('2024-08-13', 5.25), ('2024-07-09', 5.50),
                  ('2024-05-21', 5.50), ('2024-04-09', 5.50), ('2024-02-27', 5.50),
              ],
          }

          def get_rate_for_month(decisions, year, month):
              last_day = date(year, 12, 31) if month == 12 else date(year, month + 1, 1) - timedelta(days=1)
              best_rate, best_date = None, None
              for dec_str, rate in decisions:
                  dec_date = datetime.strptime(dec_str, '%Y-%m-%d').date()
                  if dec_date <= last_day:
                      if best_date is None or dec_date > best_date:
                          best_date, best_rate = dec_date, rate
              return best_rate

          os.makedirs('rates', exist_ok=True)
          today = date.today()
          months = []
          y, m = 2024, 1
          while (y, m) <= (today.year, today.month):
              months.append((y, m))
              m += 1
              if m > 12:
                  m, y = 1, y + 1

          for currency, decisions in DECISIONS.items():
              obs = []
              for year, month in months:
                  rate = get_rate_for_month(decisions, year, month)
                  if rate is not None:
                      obs.append({'date': f'{year}-{month:02d}-01', 'value': str(rate), 'source': 'investing-com-exact'})
              obs.sort(key=lambda x: x['date'], reverse=True)
              with open(f'rates/{currency}.json', 'w') as f:
                  json.dump({'observations': obs, 'lastUpdate': str(today), 'totalObservations': len(obs)}, f, indent=2)
              print(f"{currency}: {len(obs)} obs | oldest={obs[-1]['date']}:{obs[-1]['value']}% -> newest={obs[0]['date']}:{obs[0]['value']}%")

          print("\nUSD last 14:")
          import json as j2
          usd = j2.load(open('rates/USD.json'))['observations']
          for o in usd[:14]:
              print(f"  {o['date']}: {o['value']}%")
          PYEOF
          python3 /tmp/write_rates.py

      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add rates/
          git diff --staged --quiet || git commit -m "Backfill exact rates from Investing.com ($(date +'%Y-%m-%d'))"
          git pull --rebase origin main || true
          git push
