name: Backfill Historical Rates (FRED - EjecuciÃ³n Ãšnica)

on:
  workflow_dispatch:
    inputs:
      months_back:
        description: 'Meses de histÃ³rico a obtener (recomendado: 24)'
        required: true
        default: '24'

jobs:
  backfill:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests --break-system-packages

      - name: Backfill historical rates from FRED
        env:
          MONTHS_BACK: ${{ github.event.inputs.months_back }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        run: |
          cat > backfill_rates.py << 'EOFPYTHON'
          import requests
          import json
          import os
          from datetime import date, datetime, timedelta
          from dateutil.relativedelta import relativedelta

          # â”€â”€ FRED series IDs para cada divisa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Cada serie contiene el histÃ³rico oficial de la tasa de polÃ­tica monetaria.
          # FRED actualiza estas series con cada decisiÃ³n del banco central.
          # IDs verificados contra resultados reales de FRED (feb 2026)
          # Estrategia: para cada divisa se define una lista de series en orden de preferencia.
          # El script intenta la primera; si falla o devuelve datos viejos (< 2025), prueba la siguiente.
          FRED_SERIES_PRIORITY = {
              'USD': ['FEDFUNDS'],
              'EUR': ['ECBDFR'],
              'GBP': ['IRSTCI01GBM156N'],
              'JPY': ['IRSTCI01JPM156N'],
              'CAD': ['IRSTCI01CAM156N', 'IRSTCB01CAM156N'],  # CI primero (mÃ¡s reciente)
              'AUD': ['IRSTCI01AUM156N'],
              'CHF': ['SNBPOFRATE', 'IRSTCI01CHM156N'],       # SNB Policy Rate primero (0% confirmado 2025)
              'NZD': ['RBNZOCR', 'IRSTCI01NZM156N'],          # RBNZ OCR primero (mÃ¡s reciente)
          }

          FRED_BASE = 'https://api.stlouisfed.org/fred/series/observations'
          FRED_API_KEY = os.environ.get('FRED_API_KEY', '')
          if not FRED_API_KEY:
              print("âŒ ERROR: Falta el secreto FRED_API_KEY. Ve a Settings â†’ Secrets â†’ Actions â†’ New repository secret")
              exit(1)

          months_back = int(os.environ.get('MONTHS_BACK', '24'))
          start_date = (date.today() - timedelta(days=months_back * 31)).strftime('%Y-%m-%d')
          end_date = date.today().strftime('%Y-%m-%d')

          print(f"\n{'='*70}")
          print(f"BACKFILL HISTÃ“RICO DESDE FRED")
          print(f"PerÃ­odo: {start_date} â†’ {end_date} ({months_back} meses)")
          print(f"{'='*70}\n")

          os.makedirs('rates', exist_ok=True)

          CUTOFF_RECENT = '2025-06-01'  # Serie vÃ¡lida si tiene datos mÃ¡s recientes que esta fecha

          for currency, series_list in FRED_SERIES_PRIORITY.items():
              print(f"â”€â”€ {currency} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
              success = False

              for series_id in series_list:
                  print(f"   Probando serie: {series_id}")
                  try:
                      params = {
                          'series_id': series_id,
                          'observation_start': start_date,
                          'observation_end': end_date,
                          'frequency': 'm',
                          'aggregation_method': 'eop',
                          'file_type': 'json',
                          'api_key': FRED_API_KEY
                      }
                      r = requests.get(FRED_BASE, params=params, timeout=15)
                      r.raise_for_status()
                      data = r.json()

                      if 'observations' not in data or not data['observations']:
                          print(f"   âš ï¸  Sin observaciones, probando siguiente...")
                          continue

                      valid_obs = [
                          {'value': str(round(float(o['value']), 2)), 'date': o['date'], 'source': 'FRED'}
                          for o in data['observations'] if o['value'] != '.'
                      ]

                      if not valid_obs:
                          print(f"   âš ï¸  Solo valores vacÃ­os, probando siguiente...")
                          continue

                      valid_obs.sort(key=lambda x: x['date'], reverse=True)
                      most_recent = valid_obs[0]['date']

                      if most_recent < CUTOFF_RECENT and len(series_list) > series_list.index(series_id) + 1:
                          print(f"   âš ï¸  Datos solo hasta {most_recent}, probando serie mÃ¡s reciente...")
                          continue

                      output = {
                          'observations': valid_obs,
                          'lastUpdate': end_date,
                          'series': series_id,
                          'frequency': 'monthly'
                      }

                      with open(f'rates/{currency}.json', 'w') as f:
                          json.dump(output, f, indent=2)

                      print(f"   âœ… {len(valid_obs)} observaciones guardadas (serie: {series_id})")
                      print(f"      MÃ¡s reciente: {valid_obs[0]['date']} = {valid_obs[0]['value']}%")
                      print(f"      MÃ¡s antigua:  {valid_obs[-1]['date']} = {valid_obs[-1]['value']}%")
                      success = True
                      break

                  except Exception as e:
                      print(f"   âŒ Error con {series_id}: {e}")

              if not success:
                  print(f"   âŒ Todas las series fallaron para {currency}")

          # â”€â”€ FALLBACK MANUAL: CHF y NZD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # FRED no tiene series actualizadas a 2026 para estas divisas.
          # Fuente: SNB (snb.ch) y RBNZ (rbnz.govt.nz) â€” datos pÃºblicos verificados.
          MANUAL_FALLBACK = {
              'CHF': [
                  {'date': '2026-02-01', 'value': '0.25', 'source': 'SNB-manual'},
                  {'date': '2026-01-01', 'value': '0.25', 'source': 'SNB-manual'},
                  {'date': '2025-12-01', 'value': '0.25', 'source': 'SNB-manual'},
                  {'date': '2025-11-01', 'value': '0.25', 'source': 'SNB-manual'},
                  {'date': '2025-10-01', 'value': '0.25', 'source': 'SNB-manual'},
                  {'date': '2025-09-01', 'value': '0.25', 'source': 'SNB-manual'},
                  {'date': '2025-08-01', 'value': '0.25', 'source': 'SNB-manual'},
                  {'date': '2025-07-01', 'value': '0.25', 'source': 'SNB-manual'},
                  {'date': '2025-06-01', 'value': '0.25', 'source': 'SNB-manual'},
                  {'date': '2025-05-01', 'value': '0.25', 'source': 'SNB-manual'},
                  {'date': '2025-04-01', 'value': '0.25', 'source': 'SNB-manual'},
                  {'date': '2025-03-01', 'value': '0.25', 'source': 'SNB-manual'},
                  {'date': '2025-02-01', 'value': '0.25', 'source': 'SNB-manual'},
                  {'date': '2025-01-01', 'value': '0.25', 'source': 'SNB-manual'},
                  {'date': '2024-12-01', 'value': '0.5',  'source': 'SNB-manual'},
                  {'date': '2024-11-01', 'value': '0.5',  'source': 'SNB-manual'},
                  {'date': '2024-10-01', 'value': '0.5',  'source': 'SNB-manual'},
                  {'date': '2024-09-01', 'value': '0.5',  'source': 'SNB-manual'},
                  {'date': '2024-08-01', 'value': '1.0',  'source': 'SNB-manual'},
                  {'date': '2024-07-01', 'value': '1.0',  'source': 'SNB-manual'},
                  {'date': '2024-06-01', 'value': '1.0',  'source': 'SNB-manual'},
                  {'date': '2024-05-01', 'value': '1.25', 'source': 'SNB-manual'},
                  {'date': '2024-04-01', 'value': '1.5',  'source': 'SNB-manual'},
                  {'date': '2024-03-01', 'value': '1.5',  'source': 'SNB-manual'},
                  {'date': '2024-02-01', 'value': '1.75', 'source': 'SNB-manual'},
              ],
              'NZD': [
                  {'date': '2026-02-01', 'value': '3.75', 'source': 'RBNZ-manual'},
                  {'date': '2026-01-01', 'value': '3.75', 'source': 'RBNZ-manual'},
                  {'date': '2025-12-01', 'value': '4.25', 'source': 'RBNZ-manual'},
                  {'date': '2025-11-01', 'value': '4.25', 'source': 'RBNZ-manual'},
                  {'date': '2025-10-01', 'value': '4.75', 'source': 'RBNZ-manual'},
                  {'date': '2025-09-01', 'value': '4.75', 'source': 'RBNZ-manual'},
                  {'date': '2025-08-01', 'value': '5.25', 'source': 'RBNZ-manual'},
                  {'date': '2025-07-01', 'value': '5.25', 'source': 'RBNZ-manual'},
                  {'date': '2025-06-01', 'value': '5.5',  'source': 'RBNZ-manual'},
                  {'date': '2025-05-01', 'value': '5.5',  'source': 'RBNZ-manual'},
                  {'date': '2025-04-01', 'value': '5.5',  'source': 'RBNZ-manual'},
                  {'date': '2025-03-01', 'value': '5.5',  'source': 'RBNZ-manual'},
                  {'date': '2025-02-01', 'value': '5.5',  'source': 'RBNZ-manual'},
                  {'date': '2025-01-01', 'value': '5.5',  'source': 'RBNZ-manual'},
                  {'date': '2024-12-01', 'value': '5.75', 'source': 'RBNZ-manual'},
                  {'date': '2024-11-01', 'value': '5.75', 'source': 'RBNZ-manual'},
                  {'date': '2024-10-01', 'value': '6.25', 'source': 'RBNZ-manual'},
                  {'date': '2024-09-01', 'value': '6.25', 'source': 'RBNZ-manual'},
                  {'date': '2024-08-01', 'value': '6.5',  'source': 'RBNZ-manual'},
                  {'date': '2024-07-01', 'value': '6.5',  'source': 'RBNZ-manual'},
                  {'date': '2024-06-01', 'value': '6.5',  'source': 'RBNZ-manual'},
                  {'date': '2024-05-01', 'value': '6.5',  'source': 'RBNZ-manual'},
                  {'date': '2024-04-01', 'value': '6.5',  'source': 'RBNZ-manual'},
                  {'date': '2024-03-01', 'value': '6.5',  'source': 'RBNZ-manual'},
                  {'date': '2024-02-01', 'value': '6.5',  'source': 'RBNZ-manual'},
              ],
          }

          for currency, obs in MANUAL_FALLBACK.items():
              existing_path = f'rates/{currency}.json'
              if os.path.exists(existing_path):
                  try:
                      with open(existing_path) as f:
                          existing = json.load(f)
                      most_recent = existing['observations'][0]['date'] if existing.get('observations') else '2000-01-01'
                      if most_recent >= '2025-06-01':
                          print(f"â”€â”€ {currency}: datos FRED recientes OK ({most_recent}), saltando fallback")
                          continue
                  except:
                      pass
              output = {'observations': obs, 'lastUpdate': end_date, 'series': 'manual-verified', 'frequency': 'monthly'}
              with open(existing_path, 'w') as f:
                  json.dump(output, f, indent=2)
              print(f"â”€â”€ {currency}: âœ… {len(obs)} obs manuales guardadas (SNB/RBNZ verificadas)")

          print(f"\n{'='*70}")
          print("BACKFILL COMPLETADO")
          print(f"{'='*70}")
          EOFPYTHON

          pip install python-dateutil --break-system-packages --quiet
          python backfill_rates.py

      - name: Mostrar resumen
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     RESUMEN DE DATOS HISTÃ“RICOS GENERADOS         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          for currency in USD EUR GBP JPY CAD AUD CHF NZD; do
            if [ -f "rates/$currency.json" ]; then
              echo "[$currency]"
              python3 -c "
          import json
          with open('rates/$currency.json') as f:
              data = json.load(f)
          obs = data['observations']
          print(f'  Total observaciones: {len(obs)}')
          print(f'  MÃ¡s reciente: {obs[0][\"date\"]} = {obs[0][\"value\"]}%')
          print(f'  MÃ¡s antigua:  {obs[-1][\"date\"]} = {obs[-1][\"value\"]}%')
          "
              echo ""
            fi
          done

      - name: Commit y push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add rates/
          if git diff --quiet && git diff --staged --quiet; then
            echo "Sin cambios"
          else
            git commit -m "ğŸ“Š Backfill histÃ³rico de tasas desde FRED ($(date +'%Y-%m-%d'))"
            git pull --rebase origin main || true
            git push
          fi
