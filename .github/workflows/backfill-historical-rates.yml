name: Backfill Historical Rates (FRED - EjecuciÃ³n Ãšnica)

on:
  workflow_dispatch:
    inputs:
      months_back:
        description: 'Meses de histÃ³rico a obtener (recomendado: 24)'
        required: true
        default: '168'

jobs:
  backfill:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests --break-system-packages

      - name: Backfill historical rates from FRED
        env:
          MONTHS_BACK: ${{ github.event.inputs.months_back }}
        run: |
          cat > backfill_rates.py << 'EOFPYTHON'
          import requests
          import json
          import os
          from datetime import date, datetime, timedelta
          from dateutil.relativedelta import relativedelta

          # â”€â”€ FRED series IDs para cada divisa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Cada serie contiene el histÃ³rico oficial de la tasa de polÃ­tica monetaria.
          # FRED actualiza estas series con cada decisiÃ³n del banco central.
          FRED_SERIES = {
              'USD': 'FEDFUNDS',          # Federal Funds Effective Rate (mensual)
              'EUR': 'ECBDFR',            # ECB Deposit Facility Rate
              'GBP': 'BOERUKM',          # Bank of England Official Rate
              'JPY': 'IRSTCB01JPM156N',  # Bank of Japan Policy Rate
              'CAD': 'IRSTCB01CAM156N',  # Bank of Canada Overnight Rate
              'AUD': 'IRSTCB01AUM156N',  # RBA Cash Rate
              'CHF': 'IRSTCB01CHM156N',  # SNB Policy Rate
              'NZD': 'IRSTCB01NZM156N',  # RBNZ Official Cash Rate
          }

          FRED_BASE = 'https://api.stlouisfed.org/fred/series/observations'
          # FRED no requiere API key para series pÃºblicas en formato JSON
          # (lÃ­mite generoso: 120 req/min sin key)

          months_back = int(os.environ.get('MONTHS_BACK', '24'))
          start_date = (date.today() - timedelta(days=months_back * 31)).strftime('%Y-%m-%d')
          end_date = date.today().strftime('%Y-%m-%d')

          print(f"\n{'='*70}")
          print(f"BACKFILL HISTÃ“RICO DESDE FRED")
          print(f"PerÃ­odo: {start_date} â†’ {end_date} ({months_back} meses)")
          print(f"{'='*70}\n")

          os.makedirs('rates', exist_ok=True)

          for currency, series_id in FRED_SERIES.items():
              print(f"â”€â”€ {currency} ({series_id}) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
              
              try:
                  params = {
                      'series_id': series_id,
                      'observation_start': start_date,
                      'observation_end': end_date,
                      'frequency': 'm',          # mensual
                      'aggregation_method': 'eop', # end-of-period (Ãºltimo dato del mes)
                      'file_type': 'json',
                      'api_key': 'e56a23e536093aa4c08de5d6b8f66cf9'  # clave pÃºblica de demo FRED
                  }
                  
                  r = requests.get(FRED_BASE, params=params, timeout=15)
                  r.raise_for_status()
                  data = r.json()
                  
                  if 'observations' not in data or not data['observations']:
                      print(f"  âŒ Sin datos para {currency}")
                      continue

                  # Filtrar observaciones vÃ¡lidas (FRED usa '.' para datos faltantes)
                  valid_obs = [
                      {
                          'value': str(round(float(o['value']), 2)),
                          'date': o['date'],
                          'source': 'FRED'
                      }
                      for o in data['observations']
                      if o['value'] != '.'
                  ]

                  # Ordenar mÃ¡s reciente primero (como espera el dashboard)
                  valid_obs.sort(key=lambda x: x['date'], reverse=True)

                  output = {
                      'observations': valid_obs,
                      'lastUpdate': end_date,
                      'series': series_id,
                      'frequency': 'monthly'
                  }

                  with open(f'rates/{currency}.json', 'w') as f:
                      json.dump(output, f, indent=2)

                  print(f"  âœ… {len(valid_obs)} observaciones guardadas")
                  print(f"     MÃ¡s reciente: {valid_obs[0]['date']} = {valid_obs[0]['value']}%")
                  print(f"     MÃ¡s antigua:  {valid_obs[-1]['date']} = {valid_obs[-1]['value']}%")

              except Exception as e:
                  print(f"  âŒ Error: {e}")

          print(f"\n{'='*70}")
          print("BACKFILL COMPLETADO")
          print(f"{'='*70}")
          EOFPYTHON

          pip install python-dateutil --break-system-packages --quiet
          python backfill_rates.py

      - name: Mostrar resumen
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     RESUMEN DE DATOS HISTÃ“RICOS GENERADOS         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          for currency in USD EUR GBP JPY CAD AUD CHF NZD; do
            if [ -f "rates/$currency.json" ]; then
              echo "[$currency]"
              python3 -c "
          import json
          with open('rates/$currency.json') as f:
              data = json.load(f)
          obs = data['observations']
          print(f'  Total observaciones: {len(obs)}')
          print(f'  MÃ¡s reciente: {obs[0][\"date\"]} = {obs[0][\"value\"]}%')
          print(f'  MÃ¡s antigua:  {obs[-1][\"date\"]} = {obs[-1][\"value\"]}%')
          "
              echo ""
            fi
          done

      - name: Commit y push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add rates/
          if git diff --quiet && git diff --staged --quiet; then
            echo "Sin cambios"
          else
            git commit -m "ðŸ“Š Backfill histÃ³rico de tasas desde FRED ($(date +'%Y-%m-%d'))"
            git pull --rebase origin main || true
            git push
          fi
