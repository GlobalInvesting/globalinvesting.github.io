name: Update FX Performance (1M momentum)
on:
  schedule:
    - cron: '0 7 * * *'
  workflow_dispatch:

jobs:
  update-fx-performance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests --break-system-packages

      - name: Create directory
        run: mkdir -p fx-performance

      - name: Fetch 1M FX performance
        run: |
          python3 << 'EOFPYTHON'
          import requests
          import json
          import time
          from datetime import date, timedelta

          HEADERS = {'User-Agent': 'Mozilla/5.0 (compatible; ForexDashboard/1.0)'}

          CURRENCIES = ['EUR', 'GBP', 'JPY', 'AUD', 'CAD', 'CHF', 'NZD']

          today = date.today()
          date_30d = today - timedelta(days=30)
          date_7d  = today - timedelta(days=7)

          today_str  = today.isoformat()
          d30_str    = date_30d.isoformat()
          d7_str     = date_7d.isoformat()

          print(f"Fetching FX performance: {d30_str} ‚Üí {today_str}")

          def fetch_rate_on_date(currency, date_str, retries=3, backoff=2):
              """
              Fetch USD/{currency} rate on a specific date via Frankfurter.
              Returns units of currency per 1 USD (i.e. how many JPY/EUR/etc per dollar).
              Includes retry logic with exponential backoff for transient failures.
              """
              url = f"https://api.frankfurter.app/{date_str}?from=USD&to={currency}"
              for attempt in range(1, retries + 1):
                  try:
                      r = requests.get(url, headers=HEADERS, timeout=12)
                      if r.ok:
                          data = r.json()
                          rate = data.get('rates', {}).get(currency)
                          if rate:
                              return float(rate)
                      else:
                          print(f"  Warning: {currency} on {date_str}: HTTP {r.status_code} (attempt {attempt}/{retries})")
                  except Exception as e:
                      print(f"  Warning: {currency} on {date_str}: {e} (attempt {attempt}/{retries})")

                  if attempt < retries:
                      sleep_s = backoff ** (attempt - 1)  # 1s, 2s
                      print(f"  Retrying in {sleep_s}s...")
                      time.sleep(sleep_s)

              print(f"  ERROR: All {retries} attempts failed for {currency} on {date_str}")
              return None

          def calc_performance(currency, rate_now, rate_before):
              """
              Calculate % change in currency value (appreciation = positive).

              If USD/CCY rate goes DOWN ‚Üí currency APPRECIATED vs USD ‚Üí positive return.
              If USD/CCY rate goes UP   ‚Üí currency DEPRECIATED vs USD ‚Üí negative return.

              Formula: (rate_before / rate_now - 1) * 100
              Example: USD/JPY was 158, now 145 ‚Üí yen appreciated 8.3% ‚Üí positive.
              Example: USD/EUR was 0.95, now 0.92 ‚Üí EUR appreciated 3.3% ‚Üí positive.
              """
              if rate_now is None or rate_before is None:
                  return None
              if rate_before == 0 or rate_now == 0:
                  return None
              # "How much has CCY gained vs USD?"
              perf = (rate_before / rate_now - 1.0) * 100.0
              return round(perf, 4)

          results = {}

          # USD performance vs basket (inverse of DXY logic)
          # USD perf = weighted inverse of other currencies (DXY weights)
          usd_perfs_1m = []

          for currency in CURRENCIES:
              print(f"\nProcessing {currency}...")

              rate_now  = fetch_rate_on_date(currency, today_str)
              rate_30d  = fetch_rate_on_date(currency, d30_str)
              rate_7d   = fetch_rate_on_date(currency, d7_str)

              print(f"  Now: {rate_now}, 30d ago: {rate_30d}, 7d ago: {rate_7d}")

              perf_1m = calc_performance(currency, rate_now, rate_30d)
              perf_1w = calc_performance(currency, rate_now, rate_7d)

              if perf_1m is not None:
                  usd_perfs_1m.append(-perf_1m)

              results[currency] = {
                  'fxPerformance1M': perf_1m,
                  'fxPerformance1W': perf_1w,
                  'rateNow':    rate_now,
                  'rate30dAgo': rate_30d,
                  'rate7dAgo':  rate_7d,
                  'date': today_str,
                  'source': 'Frankfurter API (ECB reference rates)'
              }

              print(f"  1M perf: {perf_1m}%  |  1W perf: {perf_1w}%")

          # USD: P-2 v4.9.6 ‚Äî Pesos DXY reales en lugar de peso igual
          # Pesos oficiales del √≠ndice DXY (ICE):
          #   EUR 57.6% | JPY 13.6% | GBP 11.9% | CAD 9.1% | CHF 3.6% | AUD+NZD 2.1% c/u
          # El peso igual previo (14.3% por divisa) sobreestimaba JPY/AUD/CAD
          # y subestimaba EUR, causando un error de ~1.04pp en Feb 2026.
          if usd_perfs_1m:
              DXY_WEIGHTS = {
                  'EUR': 0.576, 'JPY': 0.136, 'GBP': 0.119,
                  'CAD': 0.091, 'CHF': 0.036, 'AUD': 0.021, 'NZD': 0.021
              }
              available = [
                  c for c in ['EUR', 'JPY', 'GBP', 'CAD', 'CHF', 'AUD', 'NZD']
                  if results.get(c, {}).get('fxPerformance1M') is not None
              ]
              total_w = sum(DXY_WEIGHTS.get(c, 0) for c in available)
              if total_w > 0:
                  usd_perf = 0.0
                  for c in available:
                      perf = results[c]['fxPerformance1M']
                      w = DXY_WEIGHTS.get(c, 0) / total_w  # renormalizar si falta alguna divisa
                      usd_perf -= perf * w  # USD se mueve inverso al resto
                  usd_perf = round(usd_perf, 4)
                  print(f"\nUSD 1M perf (DXY-weighted, {len(available)}/{len(CURRENCIES)} currencies): {usd_perf}%")
              else:
                  # fallback: peso igual si DXY_WEIGHTS no cubre ninguna divisa disponible
                  usd_perf = round(sum(usd_perfs_1m) / len(usd_perfs_1m), 4)
                  print(f"\nUSD 1M perf (fallback equal-weight): {usd_perf}%")
          else:
              usd_perf = None
              print("\nUSD 1M perf: None (no currency data available)")

          results['USD'] = {
              'fxPerformance1M': usd_perf,
              'fxPerformance1W': None,
              'rateNow':    1.0,
              'rate30dAgo': 1.0,
              'rate7dAgo':  1.0,
              'date': today_str,
              'source': 'Computed as DXY-weighted inverse of currency basket (P-2 v4.9.6)'
          }

          # Save individual files
          import os
          os.makedirs('fx-performance', exist_ok=True)

          all_currencies = ['USD'] + CURRENCIES
          for curr in all_currencies:
              if curr in results:
                  with open(f'fx-performance/{curr}.json', 'w') as f:
                      json.dump(results[curr], f, indent=2)
                  status = '‚úì' if results[curr]['fxPerformance1M'] is not None else '‚úó NULL'
                  print(f"Saved fx-performance/{curr}.json: 1M={results[curr]['fxPerformance1M']}% [{status}]")

          # Summary
          print("\n" + "="*60)
          print("FX PERFORMANCE SUMMARY (1M, currency appreciation vs USD)")
          print("="*60)
          sorted_results = sorted(
              [(c, d['fxPerformance1M']) for c, d in results.items() if d['fxPerformance1M'] is not None],
              key=lambda x: x[1], reverse=True
          )
          for curr, perf in sorted_results:
              bar = '‚ñà' * int(abs(perf))
              sign = '+' if perf >= 0 else ''
              print(f"  {curr}: {sign}{perf:+.2f}%  {bar}")

          # Warn about any nulls
          nulls = [c for c, d in results.items() if d['fxPerformance1M'] is None]
          if nulls:
              print(f"\n‚ö†Ô∏è  NULL results (API failures): {', '.join(nulls)}")
              print("   These currencies will not contribute to their fxPerformance1M score.")
          EOFPYTHON

      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add fx-performance/
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üìà FX performance update $(date +'%Y-%m-%d') ‚Äî 1M momentum DXY-weighted"
            git pull --rebase origin main || true
            git push
          fi
