name: Update USD Index COT (CFTC Official)
on:
  schedule:
    - cron: '30 20 * * 5'  # Fridays at 8:30 PM UTC
  workflow_dispatch:

jobs:
  update-usd-cot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests --break-system-packages
      
      - name: Fetch USD Index COT from CFTC
        run: |
          python3 << 'EOFPYTHON'
          import requests
          import json
          import re
          from datetime import date
          import os

          print("="*70)
          print("FETCHING US DOLLAR INDEX COT FROM CFTC")
          print("="*70)

          CFTC_URL = "https://www.cftc.gov/dea/futures/deanybtsf.htm"

          try:
              print(f"\nğŸ” Fetching {CFTC_URL}...")
              response = requests.get(CFTC_URL, timeout=30)
              response.raise_for_status()
              
              content = response.text
              
              # Buscar la secciÃ³n del US Dollar Index
              # PatrÃ³n corregido: permite espacios y saltos de lÃ­nea entre elementos
              usd_pattern = re.search(
                  r'\(U\.S\. DOLLAR INDEX[^)]*\).*?'   # Header hasta el cierre de parÃ©ntesis
                  r'COMMITMENTS\s+'                     # "COMMITMENTS" seguido de espacios
                  r'([\d,]+)\s+([\d,]+)',              # LONG y SHORT (permite comas)
                  content,
                  re.DOTALL | re.IGNORECASE
              )
              
              if usd_pattern:
                  # Eliminar comas de los nÃºmeros
                  long_str = usd_pattern.group(1).replace(',', '')
                  short_str = usd_pattern.group(2).replace(',', '')
                  
                  long_positions = int(long_str)
                  short_positions = int(short_str)
                  net_position = long_positions - short_positions
                  
                  print(f"\nâœ… FOUND USD INDEX DATA:")
                  print(f"   Long:  {long_positions:,}")
                  print(f"   Short: {short_positions:,}")
                  print(f"   Net:   {net_position:+,}")
                  
                  # Guardar en formato consistente
                  cot_data = {
                      'netPosition': net_position,
                      'longPositions': long_positions,
                      'shortPositions': short_positions,
                      'source': 'CFTC (US Dollar Index - ICE Futures)',
                      'reportDate': str(date.today()),
                      'lastUpdate': str(date.today()),  # â† Permite detecciÃ³n de staleness en el dashboard
                      'url': CFTC_URL
                  }
                  
                  os.makedirs('cot-data', exist_ok=True)
                  
                  with open('cot-data/USD.json', 'w') as f:
                      json.dump(cot_data, f, indent=2)
                  
                  print(f"\nâœ… Saved to cot-data/USD.json")
                  print(f"   Net Position: {net_position:+,} contracts")
                  
              else:
                  print("\nâŒ Pattern not matched. Trying line-by-line approach...")
                  
                  # MÃ©todo alternativo: buscar lÃ­nea por lÃ­nea
                  lines = content.split('\n')
                  found_commitments = False
                  
                  for i, line in enumerate(lines):
                      if 'U.S. DOLLAR INDEX' in line.upper():
                          print(f"\nFound 'U.S. DOLLAR INDEX' at line {i}")
                          
                          # Buscar "COMMITMENTS" en las prÃ³ximas 5 lÃ­neas
                          for j in range(i, min(i+10, len(lines))):
                              if 'COMMITMENTS' in lines[j].upper():
                                  print(f"Found 'COMMITMENTS' at line {j}")
                                  
                                  # La siguiente lÃ­nea deberÃ­a tener los datos
                                  if j+1 < len(lines):
                                      data_line = lines[j+1].strip()
                                      print(f"Data line: '{data_line}'")
                                      
                                      # Extraer nÃºmeros (acepta con o sin comas)
                                      numbers = re.findall(r'[\d,]+', data_line)
                                      
                                      if len(numbers) >= 2:
                                          long_positions = int(numbers[0].replace(',', ''))
                                          short_positions = int(numbers[1].replace(',', ''))
                                          net_position = long_positions - short_positions
                                          
                                          print(f"\nâœ… EXTRACTED DATA:")
                                          print(f"   Long:  {long_positions:,}")
                                          print(f"   Short: {short_positions:,}")
                                          print(f"   Net:   {net_position:+,}")
                                          
                                          cot_data = {
                                              'netPosition': net_position,
                                              'longPositions': long_positions,
                                              'shortPositions': short_positions,
                                              'source': 'CFTC (US Dollar Index - ICE Futures)',
                                              'reportDate': str(date.today()),
                                              'lastUpdate': str(date.today()),  # â† Permite detecciÃ³n de staleness en el dashboard
                                              'url': CFTC_URL
                                          }
                                          
                                          os.makedirs('cot-data', exist_ok=True)
                                          
                                          with open('cot-data/USD.json', 'w') as f:
                                              json.dump(cot_data, f, indent=2)
                                          
                                          print(f"\nâœ… Saved to cot-data/USD.json")
                                          found_commitments = True
                                          break
                          
                          if found_commitments:
                              break
                  
                  if not found_commitments:
                      print("\nâŒ Could not extract data from CFTC report")
                      exit(1)
          
          except Exception as e:
              print(f"\nâŒ ERROR: {e}")
              import traceback
              traceback.print_exc()
              exit(1)
          
          EOFPYTHON
      
      - name: Display USD COT data
        run: |
          if [ -f "cot-data/USD.json" ]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘         USD INDEX COT SUMMARY                  â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            python3 -c "
          import json
          with open('cot-data/USD.json') as f:
              data = json.load(f)
              print(f\"  Net Position: {data['netPosition']:+,} contracts\")
              print(f\"  Long:  {data['longPositions']:,}\")
              print(f\"  Short: {data['shortPositions']:,}\")
              print(f\"  Source: {data['source']}\")
              print(f\"  Report Date: {data['reportDate']}\")
              print(f\"  Last Update: {data.get('lastUpdate', 'N/A')}\")
          "
          else
            echo "âŒ USD.json not created"
            exit 1
          fi
      
      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add cot-data/USD.json
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ“Š USD Index COT update $(date +'%Y-%m-%d') - CFTC official"
            git pull --rebase origin main || true
            git push
          fi
